name: Update Releases Data (Alternative)

on:
#  schedule:
#    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-releases-alt.yml'

permissions:
  contents: write

jobs:
  update-releases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch releases using GitHub Script
      uses: actions/github-script@v7
      id: fetch-releases
      with:
        script: |
          const { data: releases } = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          console.log(`Fetched ${releases.length} releases`);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          const fs = require('fs');
          const path = require('path');
          
          const docsDir = path.join(process.env.GITHUB_WORKSPACE, 'docs');
          if (!fs.existsSync(docsDir)) {
            fs.mkdirSync(docsDir, { recursive: true });
          }
          
          const releasesFile = path.join(docsDir, 'releases.json');
          const metaFile = path.join(docsDir, 'releases_meta.json');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑—ã
          fs.writeFileSync(releasesFile, JSON.stringify(releases, null, 2));
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
          const meta = {
            last_updated: new Date().toISOString(),
            repository: context.repo.repo,
            owner: context.repo.owner,
            total_releases: releases.length
          };
          
          fs.writeFileSync(metaFile, JSON.stringify(meta, null, 2));
          
          return releases.length;

    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if [ -z "$(git status --porcelain docs/)" ]; then
          echo "No changes to commit"
          exit 0
        fi
        
        git add docs/
        git commit -m "üì¶ Auto-update releases data [skip ci]"
        git push
        echo "Changes committed and pushed"
