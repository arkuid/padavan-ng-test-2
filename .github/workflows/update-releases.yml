name: Update Releases Data

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² Ð¿Ð¾Ð»Ð½Ð¾Ñ‡ÑŒ UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/update-releases.yml'

permissions:
  contents: write

jobs:
  update-releases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Fetch releases from GitHub API
      run: |
        mkdir -p docs
        
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ GitHub API Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð»Ñ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             "https://api.github.com/repos/${{ github.repository }}/releases" \
             > docs/releases.json
        
        # Ð•ÑÐ»Ð¸ GITHUB_TOKEN Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        if [ ! -s docs/releases.json ] || grep -q '"message"' docs/releases.json; then
          echo "Trying without auth token..."
          curl -s -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/releases" \
               > docs/releases.json
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        if [ ! -s docs/releases.json ]; then
          echo "Error: releases.json is empty or not created"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
        if ! jq empty docs/releases.json 2>/dev/null; then
          echo "Error: releases.json is not valid JSON"
          exit 1
        fi
        
        echo "Releases data saved to docs/releases.json"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ
        cat > docs/releases_meta.json << EOF
{
  "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "repository": "${{ github.repository }}",
  "total_releases": $(jq length docs/releases.json)
}
EOF

    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Commit and push changes
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
        git status --porcelain
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git add docs/releases.json docs/releases_meta.json
          git commit -m "ðŸ“¦ Auto-update releases data [skip ci]"
          git push
          echo "Changes committed and pushed"
        fi
