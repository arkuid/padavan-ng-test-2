  build:
    runs-on: ubuntu-latest
    container: ghcr.io/arkuid/padavan-ng-test-2:latest
    needs: 
      - check-toolchain-changes
      - check-changes
    if: |
      (needs.check-changes.result == 'success' || needs.check-changes.result == 'skipped') &&
      (needs.check-changes.outputs.should-build == 'true' || github.event_name == 'workflow_dispatch')
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug workspace structure
      run: |
        echo "=== Workspace structure ==="
        pwd
        ls -la
        echo "=== Patches directory ==="
        find . -name "patches" -type d 2>/dev/null | head -5
        if [ -d "patches" ]; then
          find patches -type f -name "*.patch" | head -10
        fi

    - name: Set router model
      run: |
        # Определяем модель роутера в зависимости от типа события
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ROUTER_MODEL="${{ github.event.inputs.router_model }}"
        else
          ROUTER_MODEL="tplink-c5-v4-16M"
        fi
        echo "ROUTER_MODEL=$ROUTER_MODEL" >> $GITHUB_ENV
        echo "Using router model: $ROUTER_MODEL"

    - name: Get configs
      run: |
        sed -i 's|\r$||g' build-${{ env.ROUTER_MODEL }}.config
        . <(cat build-${{ env.ROUTER_MODEL }}.config)
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone --depth 1 "https://github.com/nilabsent/padavan-ng.git"
        
        # Скачиваем toolchain
        cd padavan-ng
        wget -q "https://github.com/arkuid/padavan-ng-test-2/releases/download/latest/toolchain.tzst"
        tar --zstd -xf toolchain.tzst
        rm toolchain.tzst
        
        # Просто проверяем что есть
        echo "=== Contents ==="
        ls -la
        echo "=== Looking for toolchain directories ==="
        find . -name "toolchain*" -type d 2>/dev/null | head -10

    - name: Apply patches and copy files
      run: |
        ROUTER_MODEL="${{ env.ROUTER_MODEL }}"
        COMMIT_SHA="${{ needs.check-changes.outputs.commit-sha }}"
        SHORT_SHA="${{ needs.check-changes.outputs.commit-short-sha }}"
        
        # Используем абсолютный путь к workspace
        WORKSPACE_PATH="$GITHUB_WORKSPACE"
        echo "Workspace: $WORKSPACE_PATH"
        echo "Looking for patches in: $WORKSPACE_PATH/patches/$ROUTER_MODEL"
        
        # Применяем патчи
        if [ -d "$WORKSPACE_PATH/patches/$ROUTER_MODEL" ] && [ "$(ls -A $WORKSPACE_PATH/patches/$ROUTER_MODEL/*.patch 2>/dev/null)" ]; then
          echo "Found patches for $ROUTER_MODEL:"
          ls -la "$WORKSPACE_PATH/patches/$ROUTER_MODEL/"
          
          echo "Applying patches for $ROUTER_MODEL..."
          cd padavan-ng
          for patch_file in $WORKSPACE_PATH/patches/$ROUTER_MODEL/*.patch; do
            echo "=== Applying patch: $(basename $patch_file) ==="
            if git apply --check "$patch_file" 2>/dev/null; then
              git apply "$patch_file"
              echo "✓ Patch applied successfully"
            else
              echo "x Applying patch with skip: $(basename $patch_file)"
              patch -p1 --forward < "$patch_file" || true
            fi
          done
          cd ..
        else
          echo "No patches found for $ROUTER_MODEL at $WORKSPACE_PATH/patches/$ROUTER_MODEL"
        fi

        # Копируем дополнительные файлы
        if [ -d "$WORKSPACE_PATH/routers/configs/$ROUTER_MODEL" ] && [ "$(ls -A $WORKSPACE_PATH/routers/configs/$ROUTER_MODEL)" ]; then
          echo "Copying config files for $ROUTER_MODEL..."
          cp -rv $WORKSPACE_PATH/routers/configs/$ROUTER_MODEL/* padavan-ng/trunk/configs/
        else
          echo "No config files found for $ROUTER_MODEL, skipping..."
        fi
        echo "Copying logo files..."
        cp -rv $WORKSPACE_PATH/routers/logo/* padavan-ng/trunk/user/www/logo/

        # Копируем основной конфиг
        cp $WORKSPACE_PATH/build-$ROUTER_MODEL.config padavan-ng/trunk/.config

    - name: Build firmware
      run: |
        ROUTER_MODEL="${{ env.ROUTER_MODEL }}"

        # Сборка прошивки
        cd padavan-ng/trunk
        ./clear_tree.sh
        ./build_firmware.sh

        # Поиск файла прошивки (используем оригинальное имя без добавления хеша)
        FW_FILE_NAME="$(find images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                        -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
        [[ -n $FW_FILE_NAME ]] || { echo "Firmware file not found"; exit 1; }
        
        # Используем оригинальное имя файла (хеш уже есть в имени)
        echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV
        echo "ORIGINAL_FW_NAME=$FW_FILE_NAME" >> $GITHUB_ENV

    - name: Prepare artifacts
      run: |
        ROUTER_MODEL="${{ env.ROUTER_MODEL }}"
        SHORT_SHA="${{ needs.check-changes.outputs.commit-short-sha }}"
        
        # Копируем прошивку в рабочую директорию
        cp "padavan-ng/trunk/images/$FW_FILE_NAME" .
        
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV
        echo "COMMIT_SHA=${{ needs.check-changes.outputs.commit-sha }}" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

    - name: Check firmware size
      run: |
        ROUTER_MODEL="${{ env.ROUTER_MODEL }}"
        partitions="padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
        max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
        fw_size="$(stat -c %s "$FW_FILE_NAME")"

        if ((fw_size > max_fw_size)); then
          fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
          max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
          echo "Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for $ROUTER_MODEL"
          exit 1
        fi

    - name: Create release ZIP archive
      uses: thedoctor0/zip-release@0.7.6
      with:
        type: 'zip'
        filename: 'padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}.zip'
        directory: '.'
        path: |
          ${{ env.FW_FILE_NAME }}
          build-${{ env.ROUTER_MODEL }}.config
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      uses: ncipollo/release-action@v1.20.0
      with:
        tag: build-${{ needs.check-changes.outputs.commit-date }}_${{ env.SHORT_SHA }}_${{ env.ROUTER_MODEL }}
        name: Build ${{ needs.check-changes.outputs.commit-date }} (${{ env.SHORT_SHA }}) - ${{ env.ROUTER_MODEL }}
        body: |
          Automated firmware build
          
          **Router model:** ${{ env.ROUTER_MODEL }}
          **Source commit:** ${{ needs.check-changes.outputs.commit-sha }}
          **Build date:** ${{ env.BUILD_TIMESTAMP }}
          
          Last commit message: ${{ needs.check-changes.outputs.latest-commit-message }}
        artifacts: 'padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}.zip'
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Trigger update-releases-alt workflow
      if: success()
      run: |
        echo "Triggering update-releases-alt workflow..."
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/update-releases-alt.yml/dispatches" \
          -d '{
            "ref": "main",
            "inputs": {
              "router_model": "${{ env.ROUTER_MODEL }}",
              "firmware_file": "${{ env.FW_FILE_NAME }}",
              "commit_date": "${{ needs.check-changes.outputs.commit-date }}",
              "commit_sha": "${{ needs.check-changes.outputs.commit-sha }}",
              "build_timestamp": "${{ env.BUILD_TIMESTAMP }}"
            }
          }'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
